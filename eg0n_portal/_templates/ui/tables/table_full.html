{% load django_tables2 %}
{% load i18n static %}
<div class="card">
    <div class="card-table">
        <div class="card-header">
            <div class="row w-full">
                {% if table.attrs.title %}
                <div class="col">
                    <h3 class="card-title mb-0">{{ table.attrs.title }}</h3>
                    <p class="text-secondary m-0">{{ table.attrs.description }}</p>
                </div>
                {% endif %}
                <div class="col-md-auto col-sm-12">
                    <div class="ms-auto d-flex flex-wrap btn-list">
                        {% if table.attrs.search %}
                        <form method="get" class="w-auto">
                            <div class="input-group input-group-flat w-auto">
                                <span class="input-group-text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="icon icon-1">
                                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                                        <path d="M21 21l-6 -6"></path>
                                    </svg>
                                </span>
                                <input id="advanced-table-search" type="text" class="form-control" autocomplete="off"
                                    name="search" value="{{ request.GET.search }}">
                            </div>
                        </form>
                        {% endif %}
                        <!-- Actions -->
                         {% if table.attrs.table_actions %}
                        <div class="dropdown">
                            <a href="#" class="btn" data-bs-toggle="dropdown">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="d-block">
                                    <path d="M5 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                    <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                    <path d="M19 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                </svg>
                            </a>
                            <div class="dropdown-menu">
                                {% for action in table.attrs.table_actions %}
                                {% if action.view %}
                                <a class="dropdown-item" href="{% url action.view %}">{{ action.button }}</a>
                                {% elif action.js %}
                                <a class="dropdown-item" href="#" onclick="{{ action.js }}">{{ action.button }}</a>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if table.attrs.table_vip_actions %}
                        {% for action in table.attrs.table_vip_actions %}
                        {% if action.view %}
                        <a href="{% url action.view %}" class="btn btn-1">{{ action.button }}</a>
                        {% elif action.js %}
                        <button type="submit" class="btn btn-primary" onclick="{{ action.js }}">
                            {{ action.button }}
                        </button>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div id="advanced-table">
            <div class="table-responsive">
                <table class="table table-vcenter table-selectable"{% if table.attrs.model %} todox-data="{{ table.attrs.model }}Crud()"{% endif %}>
                    <thead>
                        <tr>
                            {% if "select" not in table.exclude %}
                            <th class="w-1"></th>
                            {% endif %}
                            {% for column in table.columns %}
                            <th {{ column.attrs.th.as_html }}>
                                {% if column.orderable %}
                                <a class="{{ column.attrs.th.class }} btn btn-action table-sort d-flex justify-content-between"
                                    data-sort="sort-{{ column.accessor | lower }}"
                                    href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">
                                    {{ column.header }}</a>
                                {% else %}
                                {{ column.header }}
                                {% endif %}
                            </th>
                            {% endfor %}
                            {% if "actions" not in table.exclude %}
                            <th class="w-1"></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody class="table-tbody">
                        {% for row in table.page.object_list|default:table.rows %}
                        <tr data-pk="{{ row.record.pk }}">
                            {% if "select" not in table.exclude %}
                            <td class="{{ table.attrs.td }}">
                                <input class="form-check-input m-0 align-middle table-selectable-check" type="checkbox"
                                    name="selected_pks"
                                    value="{{ row.record.pk }}"
                                    aria-label="Select invoice">
                            </td>
                            {% endif %}
                            {% for column, cell in row.items %}
                            <td {{ column.attrs.td.as_html }}>
                                {{ cell }}
                            </td>
                            {% endfor %}
                            {% if "actions" not in table.exclude %}
                            <td>
                                <div class="btn-list flex-nowrap">
                                    {% if table.attrs.row_actions|length == 1 %}
                                    {% with action=table.attrs.row_actions.0 %}
                                    {% if action.view %}
                                    <a class="btn btn-1" href="{% url action.view row.record.pk %}?back={{ request.resolver_match.view_name }}"> {{ action.button }}</a>
                                    {% elif action.js %}
                                    <a class="btn btn-1" href="#" onclick="{{ action.js }}"> {{ action.button }}</a>
                                    {% endif %}
                                    {% endwith %}
                                    {% elif table.attrs.row_actions|length > 1 %}
                                    <a href="#" class="btn" data-bs-toggle="dropdown">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" class="d-block">
                                            <path d="M5 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                            <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                            <path d="M19 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                                        </svg>
                                    </a>
                                    <div class="dropdown-menu">
                                        {% for action in table.attrs.row_actions %}
                                        {% if action.view %}
                                        <a class="dropdown-item" href="{% url action.view row.record.pk %}?back={{ request.resolver_match.view_name }}">{{ action.button }}</a>
                                        {% elif action.js %}
                                        <a class="dropdown-item" href="#" onclick="{{ action.js }}">{{ action.button }}</a>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ table.columns|length }}" class="text-center text-muted">
                                No records found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% include "ui/tables/pagination.html" %}
        </div>
    </div>
</div>

<script>
    function ObjectBulkDeleteView(model_name) {
        event.preventDefault();  // Prevent standard submit

        // Select all selected checkboxes
        let selected = document.querySelectorAll('input[name="selected_pks"]:checked');

        // Collect all IDs
        let ids = Array.from(selected).map(cb => cb.value);

        // Create a dynamic form for POST
        let form = document.createElement("form");
        form.method = "POST";
        form.action = `/${model_name}/delete`;

        // Add CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrfmiddlewaretoken";
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);

        // Add selected IDs
        ids.forEach(id => {
            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "selected_ids"; // nome atteso dalla tua view
            input.value = id;
            form.appendChild(input);
        });

        // Add the form to the body and submit
        document.body.appendChild(form);
        form.submit();

    }
    function TokenCreateView() {
        event.preventDefault();  // Prevent standard submit

        // Create a dynamic form for POST
        let form = document.createElement("form");
        form.method = "POST";
        form.action = "/token/create";

        // Add CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrfmiddlewaretoken";
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);

        // Add the form to the body and submit
        document.body.appendChild(form);
        form.submit();
    }
    function RescanView(model_name) {
        /**
         * Trigger a rescan of the Proxmox infrastructure by sending a POST request to the API.
         * Uses prependLog() to display errors on API failure, HTTP errors, network errors, and timeouts.
         */
        event.preventDefault();  // Prevent standard submit
        url = `/api/${model_name}/rescan/`;
        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Just wait for websocket event
                } else {
                    // API returned error status, show message using prependLog
                    prependLog(40, `API error: ${data.message || "Unknown error"}`);
                }
            })
            .catch(error => {
                // Catch network errors, timeouts, and other exceptions, then prepend log
                prependLog(30, `Failed request to ${url}: ${error.message}`);
            });
    }
</script>
